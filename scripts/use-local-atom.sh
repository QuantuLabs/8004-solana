#!/usr/bin/env bash
#
# Setup local ATOM Engine development for 8004-solana
#
# This script configures your workspace to use a local 8004-atom checkout
# instead of fetching from GitHub. Useful when developing both repos simultaneously.
#
# Usage:
#   ./scripts/use-local-atom.sh ../8004-atom
#   ./scripts/use-local-atom.sh /absolute/path/to/8004-atom
#   ./scripts/use-local-atom.sh --remove   # Revert to GitHub dependency
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CARGO_CONFIG="$PROJECT_DIR/.cargo/config.toml"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

usage() {
  echo "Usage: $0 <path-to-8004-atom>  | --remove"
  echo ""
  echo "  <path>     Path to your local 8004-atom checkout"
  echo "  --remove   Remove local override, use GitHub dependency"
  echo ""
  echo "Examples:"
  echo "  $0 ../8004-atom"
  echo "  $0 /home/user/repos/8004-atom"
  echo "  $0 --remove"
  exit 1
}

remove_override() {
  if [ -f "$CARGO_CONFIG" ]; then
    rm "$CARGO_CONFIG"
    echo -e "${GREEN}Removed .cargo/config.toml — using GitHub dependency${NC}"
  else
    echo -e "${YELLOW}No .cargo/config.toml found, already using GitHub dependency${NC}"
  fi
  exit 0
}

[ $# -lt 1 ] && usage
[ "$1" = "--help" ] || [ "$1" = "-h" ] && usage
[ "$1" = "--remove" ] && remove_override

ATOM_PATH="$1"

# Resolve relative path from project root
if [[ ! "$ATOM_PATH" = /* ]]; then
  ATOM_PATH="$(cd "$PROJECT_DIR" && cd "$ATOM_PATH" 2>/dev/null && pwd)" || {
    echo -e "${RED}Error: Cannot resolve path '$1' from $PROJECT_DIR${NC}"
    exit 1
  }
fi

# Validate the path
ATOM_PROGRAM="$ATOM_PATH/programs/atom-engine"
if [ ! -d "$ATOM_PROGRAM" ]; then
  echo -e "${RED}Error: $ATOM_PROGRAM not found${NC}"
  echo "Make sure the path points to a valid 8004-atom checkout"
  exit 1
fi

if [ ! -f "$ATOM_PROGRAM/Cargo.toml" ]; then
  echo -e "${RED}Error: $ATOM_PROGRAM/Cargo.toml not found${NC}"
  exit 1
fi

# Compute relative path from project root for cleaner config
REL_PATH="$(python3 -c "import os; print(os.path.relpath('$ATOM_PROGRAM', '$PROJECT_DIR'))" 2>/dev/null || echo "$ATOM_PROGRAM")"

# Create .cargo directory if needed
mkdir -p "$PROJECT_DIR/.cargo"

# Write config
cat > "$CARGO_CONFIG" << EOF
# Auto-generated by scripts/use-local-atom.sh
# Points to local ATOM Engine checkout for development
# Remove with: ./scripts/use-local-atom.sh --remove

[patch."https://github.com/QuantuLabs/8004-atom.git"]
atom-engine = { path = "$REL_PATH" }
EOF

echo -e "${GREEN}Created .cargo/config.toml${NC}"
echo -e "  ATOM path: ${YELLOW}$REL_PATH${NC}"
echo ""

# Check if ATOM is built
ATOM_SO="$ATOM_PATH/target/deploy/atom_engine.so"
if [ -f "$ATOM_SO" ]; then
  echo -e "${GREEN}ATOM binary found:${NC} $ATOM_SO"
else
  echo -e "${YELLOW}Warning: ATOM not built yet. Run:${NC}"
  echo "  cd $ATOM_PATH && anchor build"
fi

echo ""
echo -e "${GREEN}Setup complete.${NC} You can now:"
echo "  1. anchor build          — Compiles registry with local ATOM CPI"
echo "  2. anchor test           — Tests use ATOM cloned from devnet"
echo ""
echo -e "${YELLOW}To test with LOCAL ATOM binary on localnet:${NC}"
echo "  Replace the ATOM [[test.validator.clone]] in Anchor.toml with:"
echo ""
echo "  [[test.genesis]]"
echo "  address = \"AToM1iKaniUCuWfHd5WQy5aLgJYWMiKq78NtNJmtzSXJ\""
echo "  program = \"$ATOM_SO\""
echo "  upgradeable = true"
echo ""
echo -e "  Then: ${GREEN}anchor test${NC}"
echo ""
echo -e "  Revert with: ${GREEN}git checkout Anchor.toml${NC}"
