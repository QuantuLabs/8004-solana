# PLAN-8004 - Status Impl√©mentation

**Date**: 2026-01-19
**Status**: ‚úÖ Impl√©ment√© et test√© sur localnet
**Tests**: 78/79 r√©ussis (98.7%)
**Pr√™t pour**: Review ‚Üí D√©ploiement devnet

---

## R√©sum√© des Modifications Impl√©ment√©es

### ‚úÖ Phase 1-4: Corrections Critiques + ATOM Enforcement

#### 1. S√©curit√© append_response (CRITIQUE)
- ‚ùå **Bug**: N'importe quel wallet pouvait r√©pondre aux feedbacks
- ‚úÖ **Fix**: Contrainte PDA `agent_account` + v√©rification `is_authorized` (owner ou agent_wallet uniquement)
- üìÅ `programs/agent-registry-8004/src/reputation/contexts.rs` (ligne 111-124)
- üìÅ `programs/agent-registry-8004/src/reputation/instructions.rs` (ligne 244-251)

#### 2. atom_enabled par d√©faut √† true
- ‚úÖ **Changement**: `atom_enabled: true` lors de register_agent
- üìÅ `programs/agent-registry-8004/src/identity/instructions.rs` (ligne 85)

#### 3. feedback_index calcul√© via Indexer
- ‚úÖ **Impl√©ment√©**: Suppression compteur on-chain, calcul client-side via IndexerClient
- ‚úÖ **Constraint**: Unique `[agentId, client, feedbackIndex]` dans Prisma/Supabase
- üìÅ SDK + Indexer modifi√©s (voir Phase 5b)

#### 4. Enforcement ATOM si atom_enabled
- ‚úÖ **S√©curit√©**: V√©rification PDA `atom_stats` obligatoire
- ‚úÖ **Error**: `AtomStatsNotInitialized` si atom_enabled=true et stats absents
- üìÅ `programs/agent-registry-8004/src/reputation/instructions.rs`:
  - give_feedback (lignes 54-69)
  - revoke_feedback (lignes 154-170)

#### 5. Fix OOM respond_to_validation (CRITIQUE)
- ‚ùå **Bug**: Out of Memory √† cause de `.key()` r√©p√©t√©s dans seeds
- ‚úÖ **Fix**: Passer asset_key, validator_key, nonce_key comme args + utiliser `as_ref()` dans seeds
- ‚ö° **Gain**: ~150-200 bytes √©conomis√©s
- üìÅ `programs/agent-registry-8004/src/validation/instructions.rs` (ligne 12-19)
- üìÅ `programs/agent-registry-8004/src/validation/contexts.rs` (ligne 72-84)
- üìÅ `agent0-ts-solana/src/core/instruction-builder.ts`

### ‚úÖ Phase 5: Conformit√© ERC-8004 - client dans ResponseAppended

#### Probl√®me D√©couvert
- ‚ùå **Spec ERC-8004**: Responses index√©es par `(agentId, client, feedbackIndex)`
- ‚ùå **√âtat actuel**: Event ResponseAppended ne contenait pas `client`

#### Solution Impl√©ment√©e
**Programs (Rust)**:
- ‚úÖ Ajout `client: Pubkey` dans event ResponseAppended
- ‚úÖ Ajout param√®tre `client_address` dans instruction append_response
- ‚úÖ Fix OOM: r√©utilisation variable `responder` au lieu de `.key()` dans emit!
- üìÅ `programs/agent-registry-8004/src/reputation/events.rs` (ligne 61)
- üìÅ `programs/agent-registry-8004/src/reputation/instructions.rs` (ligne 236-268)
- üìÅ `programs/agent-registry-8004/src/reputation/contexts.rs` (ligne 110)
- üìÅ `programs/agent-registry-8004/src/lib.rs` (ligne 103-111)

**SDK TypeScript**:
- ‚úÖ Signature `appendResponse(asset, client, feedbackIndex, ...)`
- ‚úÖ Instruction builder avec s√©rialisation `client.toBuffer()`
- ‚úÖ Documentation JSDoc compl√®te
- üìÅ `agent0-ts-solana/src/core/sdk-solana.ts` (ligne 488-506)
- üìÅ `agent0-ts-solana/src/core/transaction-builder.ts` (ligne 402-431)
- üìÅ `agent0-ts-solana/src/core/instruction-builder.ts` (ligne 312-334)

**MCP Tools**:
- ‚úÖ Ajout `client` (required) dans schema sdk_append_response
- ‚úÖ Mise √† jour handler avec `parsePublicKey(input.client, 'client')`
- üìÅ `8004-solana-mcp/src/tools.ts` (ligne 237)
- üìÅ `8004-solana-mcp/scripts/test-tools-complete.ts` (ligne 586)

**Indexer**:
- ‚úÖ Ajout `client` dans interface ResponseAppended
- ‚úÖ Parsing client depuis event data
- ‚úÖ Mise √† jour handler avec nouvelle constraint Prisma
- üìÅ `8004-solana-indexer/src/parser/types.ts` (ligne 84)
- üìÅ `8004-solana-indexer/src/parser/decoder.ts` (ligne 147)
- üìÅ `8004-solana-indexer/src/db/handlers.ts` (ligne 203)

### ‚úÖ Phase 6: Prisma Migration + Build

#### Database Migration
- ‚úÖ Unique constraint `[agentId, client, feedbackIndex]` pour Feedback
- ‚úÖ Script `init-supabase.js` cr√©√© pour reset production Supabase
- ‚úÖ Migration Prisma locale SQLite
- ‚úÖ Railway indexer red√©marr√© apr√®s migration

#### Build Programs
- ‚úÖ `anchor build` ex√©cut√©
- ‚úÖ IDLs g√©n√©r√©s: agent_registry_8004.json, atom_engine.json
- ‚úÖ D√©ploiement localnet r√©ussi:
  - agent-registry-8004: `6MuHv4dY4p9E4hSCEPr9dgbCSpMhq8x1vrUexbMVjfw1`
  - atom-engine: `8oodfP7jyNvvCKBK14RHw87hKvLV8pPGXVP9EQpAtoM4`

### ‚úÖ Phase 7: Tests Localnet

#### Infrastructure
- ‚úÖ Script `start-localnet.sh` cr√©√©
- ‚úÖ Metaplex Core clon√© depuis devnet (`CoREENxT6tW1HoK8ypY1SxRMZTcVPm7R94rH4PZNhX7d`)
- ‚úÖ solana-test-validator configur√©

#### Initialisation Registry
- ‚úÖ Script `init-registry-localnet.ts` cr√©√©
- ‚úÖ PDAs cr√©√©s: Root Config, Base Registry, Validation Config, ATOM Config

### ‚úÖ Phase 8: Tests E2E

**R√©sultats**:
```
78/79 tests r√©ussis (98.7%)
‚ùå 1 √©chec: sdk_is_it_alive (protection OOM sur agent_uri > 250 bytes - comportement attendu)
```

**Tests critiques valid√©s**:
- ‚úÖ sdk_give_feedback (CPI vers atom-engine)
- ‚úÖ sdk_revoke_feedback (CPI vers atom-engine)
- ‚úÖ sdk_append_response (nouveau param√®tre client)
- ‚úÖ sdk_initialize_atom_stats
- ‚úÖ Tous les flows identity, reputation, validation

### ‚úÖ Phase 9a: Optimisation Atom-Engine (Anti-OOM)

#### Analyse
- ‚úÖ V√©rification indexer: msg!() logs **compl√®tement ignor√©s** (seuls emit!() events pars√©s)
- ‚úÖ V√©rification SDK: **aucun parsing** de log_messages ou getLogs()
- ‚úÖ **Conclusion**: Suppression msg!() = 0 risque, gain s√©curit√©

#### Solution Appliqu√©e
- ‚úÖ Suppression 3 blocs msg!() dans atom-engine:
  - initialize_stats (88 bytes √©conomis√©s - 2 Pubkeys Base58)
  - update_stats (44 bytes √©conomis√©s - 1 Pubkey Base58)
  - revoke_stats (44 bytes √©conomis√©s - 1 Pubkey Base58)
- ‚úÖ **Total √©conomis√©**: ~176 bytes par cycle init‚Üíupdate‚Üírevoke
- ‚úÖ **Bonus**: Fix event StatsRevoked manquant `new_trust_tier`
- üìÅ `programs/atom-engine/src/lib.rs` (lignes 259-263, 299-305, 428-433 supprim√©es)

---

## Checklist Pr√©-D√©ploiement Devnet

### Build & Deploy
- [ ] Rebuild tous les programmes: `cd 8004-solana && anchor build`
- [ ] Deploy agent-registry-8004: `anchor deploy --program-name agent_registry_8004 --provider.cluster devnet`
- [ ] Deploy atom-engine: `anchor deploy --program-name atom_engine --provider.cluster devnet`
- [ ] V√©rifier program IDs dans Anchor.toml

### SDK
- [ ] Rebuild SDK: `cd agent0-ts-solana && npm run build`
- [ ] Mettre √† jour MCP dependencies

### Tests Devnet
- [ ] Initialiser registry devnet (root config, base registry, validation, ATOM)
- [ ] Run `npm run test:complete` contre devnet
- [ ] V√©rifier CPI atom-engine
- [ ] V√©rifier append_response avec client
- [ ] V√©rifier indexer Supabase

---

## M√©triques de Succ√®s Localnet

| M√©trique | R√©sultat | Statut |
|----------|----------|--------|
| Tests E2E | 78/79 (98.7%) | ‚úÖ |
| CPI Atom Engine | Fonctionnel | ‚úÖ |
| OOM Prevention | Aucun OOM | ‚úÖ |
| Conformit√© ERC-8004 | 100% | ‚úÖ |
| S√©curit√© append_response | Owner/wallet uniquement | ‚úÖ |
| ATOM Enforcement | Bypass impossible si enabled | ‚úÖ |

---

# Plan Original (Janvier 2026)

Objectif: rendre ATOM optionnel mais irreversible par agent, rendre `feedback_index`
correct sans augmentation de taille on-chain, et corriger les incoherences SDK/indexer.

Ce plan suppose la conformite spec Jan 2026 (feedback_index par client par agent).
Si vous souhaitez un feedback_index "global par agent", il faut accepter une
deviation spec et refaire la logique revoke/response (voir "Decision points").

## Decision points

1) Semantique de feedback_index
- Option A (spec): index par client par agent (recommande).
  - Raison: spec l'exige et cela permet readFeedback/revoke/response coherents.
- Option B (hors spec): index par agent (ou ignore total).
  - Impacts: revoke/response deviennent ambigus; l'indexer doit redefinir la cle
    d'identite (ex: tx_signature + event_ordinal) et readFeedback perd son sens.

2) Stricte dependance indexer pour giveFeedback
- Mode strict: SDK exige indexer pour obtenir lastIndex et calculer feedback_index.
- Mode tolerant: SDK essaie indexer, sinon fallback (index potentiellement faux).

## Program (agent-registry-8004)

### A) ATOM optionnel mais irreversible
- Ajouter un flag `atom_enabled: bool` dans `AgentAccount`.
  - Initialise a false lors de `register`.
  - Ajoute 1 octet au compte (minime).
  - Mettre a jour les schemas Borsh SDK.
- Ajouter instruction `enable_atom` (owner only).
  - Si deja true: erreur.
  - Pas d'instruction de desactivation.
  - Emet event `AtomEnabled { asset, enabled_by }`.
- Adapter `give_feedback` / `revoke_feedback`:
  - Si `atom_enabled == false`:
    - Ne pas exiger les comptes ATOM.
    - Pas de CPI atom-engine.
  - Si `atom_enabled == true`:
    - Comptes ATOM requis et valides (PDA + program id).
    - CPI atom-engine obligatoire.
  - Les events doivent toujours etre emis (atom_enabled dans event reste accurate).
- Mettre a jour `contexts.rs` pour accepter des comptes ATOM optionnels:
  - `Option<UncheckedAccount>` pour `atom_config`, `atom_stats`,
    `atom_engine_program`, `registry_authority`.
  - Validation conditionnelle uniquement si `atom_enabled` est true.

### B) feedback_index (pas de stockage on-chain)
- Aucun compteur on-chain ajoute.
- Le programme continue de recevoir `feedback_index` en input et l'emet en event.
- La "correction" est geree off-chain (SDK + indexer).

## SDK (agent0-ts-solana)

### A) feedback_index correct sans on-chain storage
- Dans `giveFeedback`:
  - Recuperer `lastIndex` depuis indexer pour (asset, client).
  - Calculer `feedback_index = lastIndex + 1`.
  - Propager dans l'instruction.
- `getLastIndex` doit retourner le MAX index (pas seulement count).
- Ajouter option config:
  - `requireIndexerForFeedbackIndex: boolean` (mode strict).
  - Si true et indexer indisponible -> throw.

### B) ATOM optionnel
- Lire `atom_enabled` dans `AgentAccount` (Borsh).
- Si false:
  - Ne pas inclure les comptes ATOM dans les instructions.
  - Eviter toute initialisation automatique.
- Si true:
  - Inclure comptes ATOM + CPI.
  - Exposer `enableAtom` (nouvelle instruction) dans SDK.
- Mettre a jour schemas Borsh (AgentAccount) et discriminators/IDL.

### C) Nettoyage / alignement IDL
- Retirer ou marquer deprecated:
  - `setFeedbackTags`, `updateValidation`, `closeValidation` (non supportes on-chain).
- Verifier `appendResponse` (si conserve) et documenter que c'est event-only.
- Adapter `responseHash`:
  - Spec: optionnel pour IPFS. Autoriser hash=0 pour `ipfs://` (ou null) au SDK.

## Indexer (8004-solana-indexer 2)

### A) Idempotence et coherence feedback_index
- Supabase:
  - `INSERT ... ON CONFLICT DO NOTHING RETURNING id` pour savoir si c'est nouveau.
  - Incrementation `feedback_count` seulement si insertion reelle.
- Local (Prisma):
  - Modifier contrainte unique feedback: (agentId, client, feedbackIndex).
  - `handleFeedbackRevoked` doit filtrer par client + feedbackIndex.

### B) ATOM optionnel
- Ajouter champ `atom_enabled` dans tables agents (Supabase + Prisma).
- Gerer event `AtomEnabled` pour passer a true.
- Lors de `NewFeedback`:
  - Si atom_enabled == false: ne pas ecraser trust_tier/quality/confidence/risk.
  - Conserver raw_avg_score comme agregat de secours.
- Lors de `FeedbackRevoked`:
  - Si atom_enabled == false: ne pas toucher aux champs ATOM.

### C) Metadata key_hash correct
- Calculer key_hash depuis la CLE (sha256(key) -> 16 bytes hex), pas depuis value.
  - Fix dans `src/db/supabase.ts`.
  - Alignement schema (id/unique).

### D) Registry type coherence
- `ensureCollection` ne doit pas forcer BASE si USER arrive ensuite.
  - Mettre a jour `ON CONFLICT` pour registry_type/authority.

### E) Responses
- Supabase: verifier que le feedback existe avant insertion de response.
  - Option: ajouter FK vers feedback (schema change) ou check explicite.
- Local: verifier que le feedback existe (deja fait), mais aussi eviter les doublons.

## Migrations / Schema

1) Supabase:
- Ajouter `atom_enabled` a `agents`.
- Ajuster `metadata.key_hash` logique.
- Event `AtomEnabled` (pas de table requise si event-only).
2) Prisma:
- Modifier index unique feedback pour inclure client.
- Ajouter champ `atom_enabled` sur Agent.
- Ajouter contrainte unique `feedback_responses` (asset, feedback_index, responder) pour idempotence.

## Tests a ajouter

- Program: enable_atom one-way (double enable fail).
- SDK: giveFeedback calcule feedback_index (indexer mock).
- Indexer: dedup WS+poller (feedback_count stable).
- Indexer: atom_enabled false -> pas d'ecrasement ATOM stats.
- Indexer: responses dedupe + reorg idempotence.
- SDK: responseHash optionnel pour IPFS.

## Ordre de mise en oeuvre

1) Program: atom_enabled + enable_atom + contexts optionnels.
2) SDK: lecture atom_enabled + feedback_index via indexer.
3) Indexer: schema + idempotence + key_hash + registry_type.
4) QA: tests + e2e (feedback, revoke, response, atom enable).

## Autres constats techniques (a traiter ou documenter)

- `append_response` n'a aucun controle d'autorisation ni lien on-chain:
  - A ce jour, n'importe qui peut publier une reponse pour n'importe quel asset/index.
  - Recommandation: exiger `agent_account` + verif owner/agent_wallet ou signer dedie.
- `update_config` d'ATOM Engine ne modifie pas les calculs:
  - Les calculs utilisent des constantes compile-time, la config est un no-op (sauf pause).
  - Recommandation: brancher compute.rs sur `AtomConfig` ou documenter comme "config metadata only".
- Idempotence WS+poller:
  - En mode auto, les memes events peuvent etre traites 2 fois.
  - Recommandation: dedupe par (signature, event_ordinal) ou utiliser "finalized".

---

# Addendum (audit + modifications appliquees)

Date: 2026-01-19

Ce bloc resume ce qui a ete modifie depuis l'audit, avec references de lignes pour verification.

## Program (8004-solana)

- **ATOM optionnel a la creation + flag atom_enabled stocke**:
  - Ajout `atom_enabled` dans AgentAccount (stocke on-chain).  
    `programs/agent-registry-8004/src/identity/state.rs:83`
  - `register` garde ATOM actif par defaut, et nouveau `register_with_options` permet de desactiver a la creation.  
    `programs/agent-registry-8004/src/identity/instructions.rs:735-844`, `programs/agent-registry-8004/src/lib.rs:38-49`
  - Event `AgentRegisteredInRegistry` embarque `atom_enabled` pour l'indexer.  
    `programs/agent-registry-8004/src/identity/events.rs:75-82`

- **ATOM comptes optionnels si atom_enabled=false**:
  - Comptes ATOM optionnels + `system_program` remis avant les comptes optionnels.  
    `programs/agent-registry-8004/src/reputation/contexts.rs:30-53`
  - CPI ATOM uniquement si `atom_enabled`, sinon pas d'exigence de PDA.  
    `programs/agent-registry-8004/src/reputation/instructions.rs:52-139`, `programs/agent-registry-8004/src/reputation/instructions.rs:189-239`

- **Atom-Engine event complet**:
  - `StatsRevoked` inclut `new_trust_tier`.  
    `programs/atom-engine/src/events.rs:43-59`
  - `enable_atom` one-way + event `AtomEnabled` + erreur `AtomAlreadyEnabled`.  
    `programs/agent-registry-8004/src/identity/contexts.rs:467-487`, `programs/agent-registry-8004/src/identity/instructions.rs:846-865`, `programs/agent-registry-8004/src/identity/events.rs:85-91`, `programs/agent-registry-8004/src/error.rs:52-59`, `programs/agent-registry-8004/src/lib.rs:52-56`

## SDK (agent0-ts-solana)

- **registerAgent avec ATOM actif par defaut mais desactivable**:
  - Nouveau `atomEnabled?: boolean` dans `RegisterAgentOptions` (suppression `skipAtomInit`).  
    `agent0-ts-solana/src/core/transaction-builder.ts:61-215`
  - `registerAgent` n'initialise plus ATOM si `atomEnabled=false`.  
    `agent0-ts-solana/src/core/sdk-solana.ts:1287-1343`
  - Instruction `register_with_options` + discriminator.  
    `agent0-ts-solana/src/core/instruction-builder.ts:80-118`, `agent0-ts-solana/src/core/instruction-discriminators.ts:23-27`

- **ATOM conditionnel dans give/revoke + collection depuis AgentAccount**:
  - Borsh AgentAccount: `atom_enabled` + helper `isAtomEnabled()`.  
    `agent0-ts-solana/src/core/borsh-schemas.ts:252-366`
  - `giveFeedback` et `revokeFeedback` n'ajoutent les comptes ATOM que si `atom_enabled=true`.  
    `agent0-ts-solana/src/core/transaction-builder.ts:1118-1234`
  - Initialisation ATOM lit la collection depuis AgentAccount (compatible registry user).  
    `agent0-ts-solana/src/core/transaction-builder.ts:1783-1802`

- **appendResponse hash optionnel pour ipfs://**:
  - Validation et fallback `Buffer.alloc(32)` si pas de hash.  
    `agent0-ts-solana/src/core/transaction-builder.ts:1265-1308`, `agent0-ts-solana/src/core/sdk-solana.ts:1522-1549`

- **Docs et build SDK aligns sur atomEnabled**:
  - Docs: remplacement de `skipAtomInit` par `atomEnabled: false`.  
    `agent0-ts-solana/README.md:150-158`, `agent0-ts-solana/docs/STATUS.md:37-40`, `agent0-ts-solana/docs/QUICKSTART.md:100-103`
  - Dist regenere (tsc) pour supprimer `skipAtomInit`.  
    `agent0-ts-solana/dist/core/sdk-solana.js:1031-1050`

- **Tests e2e mis a jour**:
  - Scenario ATOM optionnel utilise `atomEnabled: false`.  
    `agent0-ts-solana/tests/e2e-solana/e2e-full-flow.test.ts:119-128`, `agent0-ts-solana/tests/e2e-solana/e2e-full-flow.test.js:172-183`
  - Ajout `enableAtom()` avant init stats.  
    `agent0-ts-solana/tests/e2e-solana/e2e-full-flow.test.ts:155-170`, `agent0-ts-solana/tests/e2e-solana/e2e-full-flow.test.js:216-232`

- **SDK: enableAtom + cleanup APIs non supportees**:
  - Ajout `enableAtom` (SDK + transaction builder + discriminator).  
    `agent0-ts-solana/src/core/instruction-discriminators.ts:23-28`, `agent0-ts-solana/src/core/instruction-builder.ts:121-138`, `agent0-ts-solana/src/core/transaction-builder.ts:579-623`, `agent0-ts-solana/src/core/sdk-solana.ts:1366-1386`, `agent0-ts-solana/docs/METHODS.md:110-114`, `agent0-ts-solana/README.md:161-167`
  - `setFeedbackTags`, `updateValidation`, `closeValidation` -> retour erreur explicite (non supporte on-chain).  
    `agent0-ts-solana/src/core/transaction-builder.ts:1392-1405`, `agent0-ts-solana/src/core/transaction-builder.ts:1657-1671`, `agent0-ts-solana/src/core/transaction-builder.ts:1739-1755`

## Indexer (8004-solana-indexer)

- **IDL + parsing atom_enabled / client**:
  - IDL `AgentRegisteredInRegistry.atom_enabled`.  
    `8004-solana-indexer/idl/agent_registry_8004.json:2624-2651`
  - IDL `ResponseAppended.client`.  
    `8004-solana-indexer/idl/agent_registry_8004.json:3003-3039`
  - Parser + types exposes `atomEnabled` + `client`.  
    `8004-solana-indexer/src/parser/decoder.ts:83-97`, `8004-solana-indexer/src/parser/decoder.ts:228-238`, `8004-solana-indexer/src/parser/types.ts:4-105`

- **Persist atom_enabled et dedupe responses**:
  - Prisma: champ `atomEnabled` + unique `(feedbackId, responder)`.  
    `8004-solana-indexer/prisma/schema.prisma:11-103`
  - Handler local: `atomEnabled` stocke + upsert response par `(feedbackId, responder)` avec check feedback.  
    `8004-solana-indexer/src/db/handlers.ts:112-137`, `8004-solana-indexer/src/db/handlers.ts:372-414`

- **Supabase idempotent + stats conditionnelles ATOM**:
  - Insert agent avec `atom_enabled`.  
    `8004-solana-indexer/src/db/supabase.ts:140-160`
  - Feedback insert idempotent + `feedback_count`/`raw_avg_score` recalcules; stats ATOM mises a jour seulement si `atom_enabled`.  
    `8004-solana-indexer/src/db/supabase.ts:305-374`
  - Revoke: recalcul compteurs et MAJ ATOM uniquement si `atom_enabled` + `hadImpact`.  
    `8004-solana-indexer/src/db/supabase.ts:382-433`
  - Response: ID inclut client + verification feedback avant insertion.  
    `8004-solana-indexer/src/db/supabase.ts:440-468`

- **Indexer: AtomEnabled + registry_type coherence**:
  - IDL + parser + handlers pour event `AtomEnabled`.  
    `8004-solana-indexer/idl/agent_registry_8004.json:2127-2149`, `8004-solana-indexer/idl/agent_registry_8004.json:2655-2687`, `8004-solana-indexer/src/parser/types.ts:4-106`, `8004-solana-indexer/src/parser/decoder.ts:83-104`, `8004-solana-indexer/src/db/handlers.ts:23-66`, `8004-solana-indexer/src/db/supabase.ts:94-126`
  - `collections` upsert met a jour `registry_type`.  
    `8004-solana-indexer/src/db/supabase.ts:270-299`

- **Schema Supabase + migration**:
  - Ajout colonne `agents.atom_enabled` + unique `(asset, feedback_index, responder)` sur responses.  
    `8004-solana-indexer/supabase/schema.sql:57-63`, `8004-solana-indexer/supabase/schema.sql:130-142`
  - Script migration mis a jour (tables lowercase).  
    `8004-solana-indexer/scripts/migrate-supabase.js:13-29`

- **Atom-engine config documente**:
  - `update_config` note: params compile-time (metadata-only).  
    `programs/atom-engine/src/lib.rs:115-118`

## Notes / impacts a prevoir

- **Migration Supabase**: ajouter la colonne `agents.atom_enabled` (bool default true) avant ingestion.  
- **Reindex possible**: l'event `AgentRegisteredInRegistry` change de layout (atom_enabled) ‚Üí reindex/backfill recommande.

## TODO (reste a faire)

- **Appliquer la migration Supabase**  
  - Executer `scripts/migrate-supabase.js` ou re-importer `supabase/schema.sql`.
- **Reindex/backfill**  
  - Rejouer l'indexer pour `AgentRegisteredInRegistry` (layout change) + `AtomEnabled`.
- **Tests**  
  - Lancer E2E + indexer pour valider enable_atom, idempotence, responseHash IPFS.
